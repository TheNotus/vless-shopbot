<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профиль пользователя</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    {% extends "base.html" %}

    {% block content %}
    <div class="container">
        <h1>Профиль пользователя: {{ user.username or 'Неизвестный пользователь' }}</h1>

        <div class="section">
            <h2>Информация о пользователе</h2>
            <div class="user-info">
                <p><strong>ID пользователя:</strong> {{ user.telegram_id }}</p>
                <p><strong>Имя пользователя:</strong> {{ user.username or 'Не указано' }}</p>
                <p><strong>Всего потрачено:</strong> {{ "%.2f"|format(user.total_spent|float) }} руб.</p>
                <p><strong>Всего месяцев куплено:</strong> {{ user.total_months }}</p>
                <p><strong>Дата регистрации:</strong> {{ user.registration_date }}</p>
                <p><strong>Статус блокировки:</strong>
                    {% if user.is_banned %}
                        <span class="status banned">Заблокирован</span>
                    {% else %}
                        <span class="status active">Активен</span>
                    {% endif %}
                </p>
            </div>
        </div>

        <div class="section">
            <h2>Список ключей пользователя</h2>
            {% if user_keys %}
            <table class="keys-table" style="width: 100%;">
                <thead>
                    <tr>
                        <th style="padding: 8px;">ID ключа</th>
                        <th style="padding: 8px;">Сервер</th>
                        <th style="padding: 8px;">Email ключа</th>
                        <th style="padding: 8px;">Название</th>
                        <th style="padding: 8px;">Дата создания</th>
                        <th style="padding: 8px;">Срок действия</th>
                        <th style="padding: 8px;">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key in user_keys %}
                    <tr>
                        <td style="padding: 8px;">{{ key.key_id }}</td>
                        <td style="padding: 8px;">{{ key.host_name }}</td>
                        <td style="padding: 8px;">{{ key.key_email }}</td>
                        <td style="padding: 8px;">{{ key.key_name or 'Без названия' }}</td>
                        <td style="padding: 8px;">{{ key.created_date }}</td>
                        <td style="padding: 8px;">{{ key.expiry_date }}</td>
                        <td style="padding: 8px;">
                            <button class="delete-btn" onclick="deleteKey('{{ key.key_id }}')">Удалить</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>У пользователя нет активных ключей.</p>
            {% endif %}
        </div>

        <div class="section">
            <h2>Доступные серверы</h2>
            {% if servers %}
            <table class="servers-table" style="width: 100%;">
                <thead>
                    <tr>
                        <th style="padding: 8px;">Название сервера</th>
                        <th style="padding: 8px;">URL</th>
                        <th style="padding: 8px;">Пользователь</th>
                        <th style="padding: 8px;">ID подключения</th>
                    </tr>
                </thead>
                <tbody>
                    {% for server in servers %}
                    <tr>
                        <td style="padding: 8px;">{{ server.host_name }}</td>
                        <td style="padding: 8px;">{{ server.host_url }}</td>
                        <td style="padding: 8px;">{{ server.host_username }}</td>
                        <td style="padding: 8px;">{{ server.host_inbound_id }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>Нет доступных серверов.</p>
            {% endif %}
        </div>
        
        <div class="section">
            <h2>Создать новый ключ</h2>
            <form id="create-key-form" method="POST" action="{{ url_for('create_key_route', user_id=user.telegram_id) }}">
                <div class="form-group">
                    <label for="server">Сервер:</label>
                    <select name="server" id="server" required>
                        {% for server in servers %}
                        <option value="{{ server.host_name }}">{{ server.host_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="key_name">Название ключа (необязательно):</label>
                    <input type="text" name="key_name" id="key_name" placeholder="Введите название ключа">
                </div>
                
                <div class="form-group">
                    <label for="days">Срок действия (дней):</label>
                    <input type="number" name="days" id="days" value="30" min="1" required>
                </div>
                
                <button type="submit" class="btn">Создать ключ</button>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        function deleteKey(keyId) {
            if (confirm('Вы уверены, что хотите удалить этот ключ?')) {
                fetch(`/delete_key/${keyId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Ключ удален:', data);
                        // Обновить страницу или удалить строку из таблицы
                        location.reload();
                    } else {
                        alert('Ошибка при удалении ключа: ' + (data.error || 'Неизвестная ошибка'));
                        console.error('Ошибка при удалении ключа:', data);
                    }
                })
                .catch(error => {
                    console.error('Ошибка при удалении ключа:', error);
                    alert('Произошла ошибка при удалении ключа');
                });
            }
        }
    </script>
    {% endblock %}
</body>
</html>